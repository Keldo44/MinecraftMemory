<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Minecraft Bingo</title>
</head>
<body draggable="false" ondragstart="return false;" ondrop="return false;">
    <div  id="items-list" draggable="false"></div>
    <div id="life-bar"></div>
    <div id="lost-screen">
        <p>Has perdido</p>
        <a href="./">Reiniciar</a>
    </div>
    <script>

        const MAX_lifes = 8;
        let lives = MAX_lifes;
        let points = 0;
        let revealedCards = 0;
        let rev1;
        let isChecking = false;



        function addHearts(){
            const lifeBar = document.getElementById("life-bar");
            
            for (var i = 0; i < MAX_lifes; i++){
                const heart = document.createElement('img');
                heart.src = 'assets/icons/heart.png';
                
                lifeBar.appendChild(heart);
            }
        }

        async function fetchItems() {
            try {
                const response = await fetch('http://localhost:3000/items');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const items = await response.json();
                displayItems(items);
                clickCardEvents();
            } catch (error) {
                console.error('Failed to fetch items:', error);
            }
        }

        function displayItems(items) {
            const itemsList = document.getElementById('items-list');
            
            
            items.forEach(item => {    
                const imgElement = document.createElement('img');
                imgElement.draggable = false;
                imgElement.src = item.img;
                imgElement.alt = item.name;
                imgElement.title = item.name;
                imgElement.width = 32; // Set the width as per your requirement
                imgElement.height = 32; // Set the height as per your requirement

                const nameElement = document.createElement('p');
                

                const card = document.createElement('div');
                card.classList.add('card');
                card.draggable = false;
                card.appendChild(imgElement);
               // card.appendChild(nameElement);

                itemsList.appendChild(card);
                
            });
            
            revealCards();
        }

        function revealCards() {
            const cards = document.querySelectorAll(".card");
            cards.forEach((card, index) => {
               
                const values = [100, 200, 300, 400, 500, 200, 200, 300, 400, 500, 300, 300, 300, 400, 500, 400, 400, 400, 400, 500, 500, 500, 500, 500, 500];
                setTimeout(() => {
                    //card.classList.add("reveal");
                }, values[index % values.length]); // Adjust delay as needed
                setTimeout(() => {
                    card.classList.add("reveal");
                },  values[index % values.length]); // Adjust delay as needed

                setTimeout(() => {
                    card.classList.remove("reveal");
                }, values[index % values.length] + 3000); // Adjust delay as needed
            });
        }
        
        function clickCardEvents(){
            const cards = document.querySelectorAll ("#items-list>*");
            // Select all card elements
            cards.forEach(card => {
                // Add a click event listener to each card
                card.addEventListener("click", (event) => {
                    // Check if the card is already revealed or if a check is in progress
                    let is_reveal = card.classList.contains("reveal");
                    if (is_reveal || isChecking) {
                        return;
                    }

                    // If no cards are revealed
                    if (revealedCards == 0) {
                        revealedCards = 1;
                        card.classList.add("reveal");
                        rev1 = card;
                    } 
                    // If one card is already revealed
                    else if (revealedCards == 1) {
                        revealedCards = 2;
                        card.classList.add("reveal");
                        rev2 = card;
                        isChecking = true; // Prevent further clicks

                        // Check for a match after a short delay
                        setTimeout(() => {
                            let sameNameItems;
                            if (rev1.querySelector('img').src == rev2.querySelector('img').src || rev1.querySelector('img').src.includes("/joker.gif") || rev2.querySelector('img').src.includes("/joker.gif")) {
                                if(rev2.querySelector('img').src.includes("/joker.gif")){
                                    console.log("rev2 es joker");
                                    sameNameItems = Array.from(cards).filter(item => 
                                        item.querySelector('img').src === rev1.querySelector('img').src && item !== rev1
                                    );

                                    sameNameItems[0].classList.add("reveal");
                                    sameNameItems[0].classList.add("hidden");    

                                    
                                }else if (rev1.querySelector('img').src.includes("/joker.gif")){
                                    console.log("rev1 es joker");
                                    sameNameItems = Array.from(cards).filter(item => 
                                        item.querySelector('img').src === rev2.querySelector('img').src && item !== rev2
                                    );
                                    sameNameItems[0].classList.add("reveal");
                                        sameNameItems[0].classList.add("hidden"); 
                                }
                                
                                
                                damage(-1);
                                
                                rev1.classList.add("hidden");
                                rev2.classList.add("hidden");
                                
                                if(points++ == 11){
                                    youLost(false);
                                }
                            } 
                            // If the cards do not match, hide them again
                            else {
                                damage(1);
                                rev1.classList.remove("reveal");
                                rev2.classList.remove("reveal");
                            }
                            // Reset the variables for the next attempt
                            rev1 = null;
                            rev2 = null;
                            revealedCards = 0;
                            isChecking = false; // Allow clicks again
                        }, 500);
                    }
                });
            });

        }
        
        function damage(dmg) {
            const lifes = document.querySelectorAll("#life-bar>*");
            
            if(dmg > 0){
                if (lifes[1].src.includes("void_heart.png")){
                    youLost(true);
                }
                for (let i = lifes.length-1; i > -1; i--) {       
                    
                    if (lifes[i].src.includes("/heart.png")) {
                        
                        lifes[i].src = lifes[i].src.replace("heart.png", "void_heart.png");
                        dmg--;
                        if(dmg == 0){
                            i = 0;
                        }
                    } 
                }
            }else if(dmg < 0){
                for (let i = 0; i < lifes.length ; i++) {       
                    if (lifes[i].src.includes("/void_heart.png")) {
                        lifes[i].src = lifes[i].src.replace("void_heart.png","heart.png");
                        dmg++;
                        if(dmg == 0){
                            i = lifes.length;
                        }
                    } 
                }
            }
            
        }

        function youLost(var1){
            const lostSc = document.getElementById("lost-screen");
            if(!var1){
                lostSc.classList.add("win");
                lostSc.querySelector("p").innerHTML = "You Win";
                lostSc.classList.add("show");
            }else{
                lostSc.classList.add("show");
            }
        }
        fetchItems();
        addHearts();
        
    </script>
</body>
</html>
